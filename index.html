<!DOCTYPE html>
<html>
<head>
    <title>Tienda 3D: Estantes con Productos Únicos</title>
    <meta charset="UTF-8">
    <style>
        /* Estilos Generales para el Cuerpo y el Canvas */
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        canvas {
            display: block;
        }

        /* --- Estilos de las Ventanas Emergentes --- */

        /* Estilo general para los pop-ups que cubren toda la pantalla */
        #welcome-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        /* Contenido del pop-up de bienvenida (imagen y botón) */
        #welcome-popup-content {
            background-color: #2c2c2c;
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            text-align: center;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Imagen dentro del pop-up de bienvenida */
        #welcome-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
            margin-bottom: 20px;
            object-fit: contain;
        }

        /* Botón "Aceptar" del pop-up de bienvenida */
        #welcome-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }

        #welcome-btn:hover {
            background-color: #0056b3;
        }
        
        /* Estilos del pop-up de producto (cuando se hace clic en un cubo) */
        #product-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2c2c2c;
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
            text-align: center;
            max-width: 400px;
            border: 2px solid #5a5a5a;
        }

        #popup-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #777;
        }

        #popup-title {
            font-size: 1.5rem;
            margin: 0 0 10px;
            font-weight: bold;
        }

        #popup-description {
            font-size: 1rem;
            margin-bottom: 20px;
        }

        #popup-link {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        #popup-link:hover {
            background-color: #0056b3;
        }

        #close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .popup-close-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 15px;
        }

        .popup-close-btn:hover {
            background-color: #c82333;
        }

        /* Estilos del pop-up de información (Acerca de, Contacto, etc.) */
        #info-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2c2c2c;
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 101;
            display: none;
            max-width: 500px;
            text-align: left;
            border: 2px solid #5a5a5a;
        }

        #info-popup-title {
            font-size: 1.5rem;
            margin: 0 0 15px;
            font-weight: bold;
            text-align: center;
        }

        #info-popup-content {
            font-size: 1rem;
            line-height: 1.5;
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 15px;
        }

        #close-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* --- Estilos de los Botones de Control --- */

        /* Contenedor principal de los botones de movimiento */
        #controls-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: grid;
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            gap: 10px;
            z-index: 99;
        }

        /* Estilo común para todos los botones de control */
        .control-button {
            width: 60px;
            height: 60px;
            background-color: rgba(50, 50, 50, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .control-button:active {
            background-color: rgba(100, 100, 100, 0.9);
        }

        /* Posicionamiento de los botones en la rejilla */
        #up-btn { grid-area: up; }
        #left-btn { grid-area: left; }
        #right-btn { grid-area: right; }
        #down-btn { grid-area: down; }

        /* Contenedor de los botones de opciones y velocidad */
        #top-buttons-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            z-index: 99;
        }

        /* Botón de velocidad, cambia de color al activarse */
        #speed-button {
            font-size: 36px;
        }

        #speed-button.active {
            background-color: #007bff;
            color: yellow;
        }

        /* Botón del menú de opciones */
        #options-button {
            font-size: 36px;
            position: relative;
        }
        
        /* Menú desplegable de opciones */
        #options-menu {
            display: none;
            background-color: rgba(50, 50, 50, 0.9);
            border-radius: 10px;
            padding: 10px;
            width: 200px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            flex-direction: column;
            gap: 5px;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
        }

        .menu-item {
            position: relative;
            background-color: #3e3e3e;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }

        .menu-item:hover {
            background-color: #555;
        }
        
        /* Estilos de la barra de progreso */
        .progress-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .menu-item .progress-bar-container {
            border-radius: 5-px;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }

        .progress-bar {
            width: 0;
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s linear;
        }

        .progress-bar.loading {
            animation: fill-bar 0.3s linear forwards;
        }

        @keyframes fill-bar {
            from { width: 0; }
            to { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="welcome-popup">
        <div id="welcome-popup-content">
            <img id="welcome-image" src="https://i.ibb.co/nqKW8Qft/40-sin-t-tulo-20250823193546.png" alt="Imagen de bienvenida">
            <button id="welcome-btn">Aceptar</button>
        </div>
    </div>
    
    <div id="product-popup">
        <button id="close-btn">&times;</button>
        <img id="popup-image" src="" alt="Imagen del producto">
        <h2 id="popup-title"></h2>
        <p id="popup-description"></p>
        <a id="popup-link" href="#" target="_blank">Ir a la página del producto</a>
        <button class="popup-close-btn" data-target="product-popup">Aceptar</button>
    </div>

    <div id="info-popup">
        <button id="close-info-btn">&times;</button>
        <h2 id="info-popup-title"></h2>
        <p id="info-popup-content"></p>
        <button class="popup-close-btn" data-target="info-popup">Aceptar</button>
    </div>

    <div id="controls-container">
        <div class="control-button" id="up-btn">↑</div>
        <div class="control-button" id="left-btn">←</div>
        <div class="control-button" id="right-btn">→</div>
        <div class="control-button" id="down-btn">↓</div>
    </div>

    <div id="top-buttons-container">
        <div class="control-button" id="options-button">
            ☰
            <div class="progress-bar-container">
                <div class="progress-bar"></div>
            </div>
        </div>
        <div class="control-button" id="speed-button">⚡</div>
        <div id="options-menu">
            <div class="menu-item" data-info="acerca-de">
                Acerca de nosotros
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
            </div>
            <div class="menu-item" data-info="contacto">
                Contacto
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
            </div>
            <div class="menu-item" data-info="politica-privacidad">
                Política de privacidad
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
            </div>
            <div class="menu-item" data-info="aviso-legal">
                Aviso legal
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
            </div>
            <div class="menu-item" data-info="terminos">
                Términos y condiciones
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar la librería Three.js
        import * as THREE from 'https://unpkg.com/three@0.126.0/build/three.module.js';

        // SECCIÓN 1: Lógica Inicial de la Página
        // ------------------------------------

        // Lógica para mostrar y ocultar el pop-up de bienvenida
        document.addEventListener('DOMContentLoaded', () => {
            const welcomePopup = document.getElementById('welcome-popup');
            const welcomeBtn = document.getElementById('welcome-btn');

            welcomeBtn.addEventListener('click', () => {
                welcomePopup.style.display = 'none';
            });
        });

        // SECCIÓN 2: Configuración del Entorno 3D (Three.js)
        // --------------------------------------------------

        // Configuración de la escena, renderizador y cámara
        const scene = new THREE.Scene();
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setClearColor(0xD8D8D8);
        document.body.appendChild(renderer.domElement);

        // Niebla para un efecto de profundidad
        const fogColor = new THREE.Color(0xD8D8D8);
        scene.fog = new THREE.Fog(fogColor, 10, 50);
        renderer.setClearColor(fogColor);

        // Contenedor para la cámara (permite rotarla y moverla fácilmente)
        const cameraContainer = new THREE.Group();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        camera.position.set(0, 5, 0);
        cameraContainer.add(camera);
        scene.add(cameraContainer);

        // Luces para iluminar la escena
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffebcc, 0.7);
        directionalLight.position.set(5, 5, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        directionalLight.shadow.camera.near = 0.1;
        directionalLight.shadow.camera.far = 800;
        directionalLight.shadow.camera.left = -15;
        directionalLight.shadow.camera.right = 15;
        directionalLight.shadow.camera.top = 15;
        directionalLight.shadow.camera.bottom = -15;
        scene.add(directionalLight);

        // SECCIÓN 3: Creación de Contenido (Estantes y Productos)
        // ------------------------------------------------------

        // Material para los estantes
        const shelfMaterial = new THREE.MeshStandardMaterial({ color: 0xA0522D });

        // Dimensiones y parámetros
        const plankWidth = 8;
        const plankHeight = 0.15;
        const plankDepth = 1.5;
        const supportHeight = 6.3;
        const supportWidth = 0.15;
        const numShelves = 8;
        const cubeSize = 0.8;
        const imageHorizontalSpacing = 1.6;
        const numCubesOnShelf = 4;
        const totalShelfHeight = numShelves * plankHeight;
        const remainingSpace = supportHeight - totalShelfHeight;
        const spaceBetweenShelves = remainingSpace / (numShelves - 1);

        // Lista de productos para la tienda
        const products = [
            { url: 'https://i.ibb.co/cXxCdgf4/61-Ydn7q-Aod-L-AC-SY606.jpg', link: 'https://amzn.to/3JsOsEV', name: 'Tracfone Moto G Play (2023) [Promoción de activación], 32 GB, Azul, Incluye 1500 min/1500 txt/1500 MB, Plan de servicio de 365 días - Smartphone prepago', description: '$ 49.99' },
            { url: 'https://i.ibb.co/dJ7jhC79/61cti-X2qpp-L-AC-SY606.jpg', link: 'https://amzn.to/4mV9ESe', name: 'TracFone [Promoción de activación] Samsung A15 5G prepago bloqueado, 64 GB, negro - Incluye plan de 30 días de $20 en llamadas y mensajes de texto ilimitados y 4 GB de datos', description: 'precio $ 59.99 precio normal $140.33 ' },
            { url: 'https://via.placeholder.com/80x80/0000FF/FFFFFF?text=Prod+3', link: 'https://www.google.com/search?q=producto3', name: 'Producto Tres', description: 'Un artículo versátil y muy popular entre los clientes.' },
            { url: 'https://via.placeholder.com/80x80/FFFF00/000000?text=Prod+4', link: 'https://www.com/search?q=producto4', name: 'Producto Cuatro', description: 'La opción perfecta para quienes buscan algo especial.' },
            { url: 'https://via.placeholder.com/80x80/FF00FF/FFFFFF?text=Prod+5', link: 'https://www.com/search?q=producto5', name: 'Producto Cinco', description: 'Un producto duradero con un diseño elegante y moderno.' },
            { url: 'https://via.placeholder.com/80x80/00FFFF/000000?text=Prod+6', link: 'https://www.com/search?q=producto6', name: 'Producto Seis', description: 'Ideal para el uso diario y muy fácil de mantener.' },
            { url: 'https://via.placeholder.com/80x80/800080/FFFFFF?text=Prod+7', link: 'https://www.com/search?q=producto7', name: 'Producto Siete', description: 'Este producto ofrece la mejor relación calidad-precio.' },
            { url: 'https://via.placeholder.com/80x80/FFA500/000000?text=Prod+8', link: 'https://www.com/search?q=producto8', name: 'Producto Ocho', description: 'Una excelente adición a tu colección con grandes características.' },
            { url: 'https://via.placeholder.com/80x80/FFA500/000000?text=Prod+8', link: 'https://www.com/search?q=producto9', name: 'Producto Nueve', description: 'Una excelente adición a tu colección con grandes características.' },
        ];

        // Objetos y variables de control
        const textureLoader = new THREE.TextureLoader();
        const clickableObjects = [];
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        // Mapeo del contenido para las ventanas de información
        const infoContent = {
            "acerca-de": {
                title: "Acerca de Nosotros",
                content: "ministoreDeals es un proyecto de Shiru Tech. Nos dedicamos a encontrar los mejores productos tecnológicos con los precios más competitivos. Somos un buscador de ofertas, un escaparate digital diseñado para simplificar tu experiencia de compra. Explora lo mejor del mercado en un solo lugar y ahorra tiempo y dinero."
            },
            "contacto": {
                title: "Contacto",
                content: "Puedes contactarnos a través de nuestro correo electrónico: soporteshiru@gmail.com o escribiendonos a nuestro número de atención al cliente +503 7557-3427. ¡Estamos aquí para ayudarte!"
            },
            "politica-privacidad": {
                title: "Política de Privacidad",
                content: `
                    <h3>Política de Privacidad

1. Introducción
Bienvenido a nuestra tienda. La privacidad de nuestros visitantes es de suma importancia para nosotros. Esta política explica cómo manejamos la información en nuestro sitio web.

2. Información que no Recopilamos
Nuestro sitio web es una plataforma de exhibición y no recopila ninguna información personal de los visitantes, como nombres, direcciones de correo electrónico, direcciones IP o cualquier otro dato identificable. No utilizamos cookies de seguimiento ni herramientas de análisis para monitorizar el comportamiento de los usuarios.

3. Enlaces a Sitios de Terceros (Afiliados)
Esta tienda funciona como un escaparate. Los productos que se muestran son seleccionados manualmente de otras tiendas online, como Amazon. Cuando haces clic en un enlace de producto, serás redirigido al sitio web de un tercero. Nuestra tienda no procesa transacciones ni maneja información de pago.

Una vez que abandonas nuestro sitio y accedes a una tienda de terceros, la privacidad de tu información queda sujeta a la política de privacidad de ese sitio. Te recomendamos leer sus políticas cuidadosamente antes de realizar cualquier compra.

4. Cambios en la Política de Privacidad
Nos reservamos el derecho de actualizar esta política de privacidad en cualquier momento. Cualquier cambio será publicado en esta misma página.

5. Contacto
Si tienes alguna pregunta sobre esta política de privacidad, puedes contactarnos a través de:  soporteshiru@gmail.com ,al aser uso de nuestra plataforma aseptas nuestra politica de privacidad.
                    <p> </p>
                    <h3> </h3>
                    <p> </p>
                    <h3> </h3>
                    <p> </p>
                `
            },
            "aviso-legal": {
                title: "Aviso Legal",
                content: `
                    <h3> Aviso Legal y Condiciones de Uso

1. Identificación del Titular
Este sitio web es operado por Shiru Tech. Para cualquier consulta, puede contactar a través de soporteshiru@gmail.com .

2. Propósito de la Plataforma
Este sitio web es una plataforma de exhibición y curaduría de productos. Su propósito es ayudar a los usuarios a encontrar los productos más económicos disponibles en tiendas de terceros. No somos los vendedores directos de los productos mostrados.

3. Enlaces de Afiliado
Este sitio participa en programas de afiliación. Esto significa que si haces clic en un enlace de producto y realizas una compra, podríamos recibir una comisión. Esto no tiene ningún costo adicional para ti y nos ayuda a mantener la plataforma en funcionamiento.

4. Limitación de Responsabilidad
No nos hacemos responsables de la exactitud de la información del producto, la calidad, el stock o el servicio al cliente de las tiendas de terceros. La transacción y cualquier problema que surja de la compra son responsabilidad exclusiva del usuario y de la tienda online de destino. Recomendamos encarecidamente revisar las políticas y los términos de uso de los sitios de terceros antes de realizar cualquier compra.

5. Propiedad Intelectual
Todo el contenido de este sitio (textos, imágenes, gráficos, etc.), a excepción de las imágenes de productos y logos que pertenecen a sus respectivos dueños, es de nuestra propiedad y está protegido por derechos de autor. No se permite su uso sin nuestro consentimiento expreso.

6. Modificaciones
Nos reservamos el derecho de modificar el contenido y las condiciones de este aviso legal en cualquier momento.</h3>
                    <p> </p>
                    <h3> </h3>
                    <p> </p>
                `
            },
            "terminos": {
                title: "Términos y Condiciones",
                content: `
                    <h3>Aceptación de los Términos</h3>
                    <p>Al acceder y utilizar este servicio, usted acepta estar sujeto a los siguientes términos y condiciones. Si no está de acuerdo con alguna parte de los términos, no debe utilizar nuestros servicios.</p>
                    <h3>Descripción del Servicio</h3>
                    <p>Nuestro servicio ofrece una experiencia de compra en un entorno 3D. Los productos mostrados pueden variar en apariencia real. Hacemos lo posible por asegurar la precisión, pero no garantizamos la exactitud de los colores ni las texturas.</p>
                    <h3>Modificaciones del Servicio</h3>
                    <p>Nos reservamos el derecho de modificar o discontinuar el servicio (o cualquier parte de él) sin previo aviso en cualquier momento. No seremos responsables ante usted ni ante ningún tercero por cualquier modificación, suspensión o interrupción del servicio.</p>
                `
            }
        };

        // Bucle para crear los estantes y productos de la tienda
        let productIndex = 0;
        const allShelves = [];
        const numRows = 3;
        const numColumns = 167;
        const rowSpacing = plankWidth * 2;
        const columnSpacing = -plankDepth * 3;

        for (let row = 0; row < numRows; row++) {
            for (let col = 0; col < numColumns; col++) {
                const shelfGroup = new THREE.Group();
                shelfGroup.position.x = (row - (numRows - 1) / 2) * rowSpacing;
                shelfGroup.position.z = col * columnSpacing;

                const leftSupport = new THREE.Mesh(new THREE.BoxGeometry(supportWidth, supportHeight, plankDepth), shelfMaterial);
                leftSupport.position.x = -plankWidth / 2 + supportWidth / 2;
                leftSupport.position.y = supportHeight / 2;
                leftSupport.castShadow = true;
                leftSupport.receiveShadow = true;
                shelfGroup.add(leftSupport);

                const rightSupport = new THREE.Mesh(new THREE.BoxGeometry(supportWidth, supportHeight, plankDepth), shelfMaterial);
                rightSupport.position.x = plankWidth / 2 - supportWidth / 2;
                rightSupport.position.y = supportHeight / 2;
                rightSupport.castShadow = true;
                rightSupport.receiveShadow = true;
                shelfGroup.add(rightSupport);

                for (let i = 0; i < numShelves; i++) {
                    const shelf = new THREE.Mesh(new THREE.BoxGeometry(plankWidth, plankHeight, plankDepth), shelfMaterial);
                    shelf.position.y = supportHeight - (i * (plankHeight + spaceBetweenShelves));
                    shelf.castShadow = true;
                    shelf.receiveShadow = true;
                    shelfGroup.add(shelf);

                    if (i > 0) {
                        for (let j = 0; j < numCubesOnShelf; j++) {
                            if (productIndex < products.length) {
                                const currentProduct = products[productIndex];
                                const startX = -((numCubesOnShelf - 1) * imageHorizontalSpacing) / 2;

                                const geometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize);
                                const productCubeMaterial = new THREE.MeshStandardMaterial({ color: 0xdeb887 });
                                const materials = [
                                    productCubeMaterial,
                                    productCubeMaterial,
                                    productCubeMaterial,
                                    productCubeMaterial,
                                    productCubeMaterial.clone(),
                                    productCubeMaterial
                                ];

                                const productCube = new THREE.Mesh(geometry, materials);

                                productCube.position.set(
                                    startX + j * imageHorizontalSpacing,
                                    shelf.position.y + plankHeight / 2 + cubeSize / 2,
                                    -plankDepth / 2 + cubeSize / 2
                                );
                                productCube.userData = { product: currentProduct };
                                clickableObjects.push(productCube);
                                shelfGroup.add(productCube);

                                textureLoader.load(currentProduct.url, (texture) => {
                                    productCube.material[4].map = texture;
                                    productCube.material[4].needsUpdate = true;
                                    productCube.material[4].color = new THREE.Color(0xffffff);
                                });

                                productIndex++;
                            }
                        }
                    }
                }

                const backBoardWidth = plankWidth + supportWidth;
                const backBoardHeight = supportHeight;
                const backBoardDepth = 0.1;
                const backBoard = new THREE.Mesh(new THREE.BoxGeometry(backBoardWidth, backBoardHeight, backBoardDepth), shelfMaterial);
                backBoard.position.z = -plankDepth / 2 - backBoardDepth / 2;
                backBoard.position.y = supportHeight / 2;
                backBoard.receiveShadow = true;
                backBoard.castShadow = true;
                shelfGroup.add(backBoard);

                scene.add(shelfGroup);
                allShelves.push(shelfGroup);
            }
        }

        // Creación del suelo
        const groundSize = 5000;
        const groundGeometry = new THREE.PlaneGeometry(groundSize, groundSize);
        const groundMaterial = new THREE.MeshStandardMaterial({ color: 0xC1C9D1, side: THREE.DoubleSide });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -0.1;
        ground.receiveShadow = false;
        scene.add(ground);

        // SECCIÓN 4: Control de Movimiento y Cámara
        // ----------------------------------------

        let isDragging = false;
        let lastClientX, lastClientY;
        const rotationSpeed = 0.005;
        const moveState = {
            forward: false,
            backward: false,
            left: false,
            right: false
        };
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        let currentSpeed = 5.0;
        const groundY = 0.0;
        let prevTime = performance.now();

        // Función para verificar si el clic fue en un elemento de la interfaz de usuario
        function isUIElement(target) {
            return target.closest('#welcome-popup') || target.closest('#product-popup') || target.closest('#info-popup') || target.closest('#controls-container') || target.closest('#top-buttons-container');
        }

        // Lógica para el movimiento y rotación con el mouse/touch
        function onPointerDown(e) {
            if (isUIElement(e.target)) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            isDragging = true;
            lastClientX = clientX;
            lastClientY = clientY;
        }

        function onPointerMove(e) {
            if (!isDragging || isUIElement(e.target)) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const deltaX = clientX - lastClientX;
            const deltaY = clientY - lastClientY;
            cameraContainer.rotation.y -= deltaX * rotationSpeed;
            camera.rotation.x -= deltaY * rotationSpeed;
            camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
            lastClientX = clientX;
            lastClientY = clientY;
        }

        function handlePointerUp(e) {
            isDragging = false;
            const isUIClick = isUIElement(e.target);
            const isCanvasClick = e.target.tagName === 'CANVAS';

            if (!isUIClick && isCanvasClick) {
                e.preventDefault();
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;

                pointer.x = (clientX / window.innerWidth) * 2 - 1;
                pointer.y = -(clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(pointer, camera);
                const intersects = raycaster.intersectObjects(clickableObjects);

                if (intersects.length > 0) {
                    const clickedObject = intersects[0].object;
                    const productData = clickedObject.userData.product;
                    const productPopup = document.getElementById('product-popup');
                    document.getElementById('popup-image').src = productData.url;
                    document.getElementById('popup-title').textContent = productData.name;
                    document.getElementById('popup-description').textContent = productData.description;
                    document.getElementById('popup-link').href = productData.link;
                    productPopup.style.display = 'block';
                    document.getElementById('options-menu').style.display = 'none';
                    document.getElementById('info-popup').style.display = 'none';
                    return;
                }
            }

            if (!isUIClick) {
                document.getElementById('product-popup').style.display = 'none';
                document.getElementById('info-popup').style.display = 'none';
                document.getElementById('options-menu').style.display = 'none';
            }
        }

        // Asignación de eventos de mouse y touch
        document.addEventListener('mousedown', onPointerDown);
        document.addEventListener('touchstart', onPointerDown, { passive: false });
        document.addEventListener('mousemove', onPointerMove);
        document.addEventListener('touchmove', onPointerMove, { passive: false });
        document.addEventListener('mouseup', handlePointerUp);
        document.addEventListener('touchend', handlePointerUp, { passive: false });

        // Eventos para cerrar los pop-ups con el botón
        document.getElementById('close-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('product-popup').style.display = 'none';
        });
        document.getElementById('close-info-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('info-popup').style.display = 'none';
        });
        document.querySelectorAll('.popup-close-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const targetId = button.getAttribute('data-target');
                document.getElementById(targetId).style.display = 'none';
            });
            button.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                const targetId = button.getAttribute('data-target');
                document.getElementById(targetId).style.display = 'none';
            });
        });

        // Lógica de los botones con "hold" y barra de progreso
        const holdDuration = 300;
        let holdTimer;
        let isHolding = false;
        let currentProgressBar = null;

        function startHoldTimer(event) {
            event.stopPropagation();
            if (isHolding) {
                clearTimeout(holdTimer);
                if (currentProgressBar) {
                    currentProgressBar.classList.remove('loading');
                    currentProgressBar.parentNode.style.display = 'none';
                }
            }
            isHolding = true;
            const target = event.currentTarget;
            const progressBarContainer = target.querySelector('.progress-bar-container');
            const progressBar = target.querySelector('.progress-bar');
            if (progressBarContainer && progressBar) {
                currentProgressBar = progressBar;
                progressBarContainer.style.display = 'block';
                progressBar.classList.add('loading');
                holdTimer = setTimeout(() => {
                    if (isHolding) {
                        if (target.id === 'options-button') {
                            document.getElementById('options-menu').style.display = 'flex';
                        } else if (target.classList.contains('menu-item')) {
                            const infoKey = target.getAttribute('data-info');
                            const data = infoContent[infoKey];
                            document.getElementById('info-popup-title').textContent = data.title;
                            document.getElementById('info-popup-content').innerHTML = data.content;
                            document.getElementById('info-popup').style.display = 'block';
                            document.getElementById('options-menu').style.display = 'none';
                        }
                    }
                    endHoldTimer();
                }, holdDuration);
            }
        }

        function endHoldTimer() {
            isHolding = false;
            clearTimeout(holdTimer);
            if (currentProgressBar) {
                currentProgressBar.classList.remove('loading');
                currentProgressBar.parentNode.style.display = 'none';
                currentProgressBar.style.width = '0%';
                currentProgressBar = null;
            }
        }

        // Eventos para los botones de opciones y menú
        const optionsButton = document.getElementById('options-button');
        optionsButton.addEventListener('mousedown', startHoldTimer);
        optionsButton.addEventListener('mouseup', endHoldTimer);
        optionsButton.addEventListener('mouseleave', endHoldTimer);
        optionsButton.addEventListener('touchstart', startHoldTimer, { passive: false });
        optionsButton.addEventListener('touchend', endHoldTimer);
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('mousedown', startHoldTimer);
            item.addEventListener('mouseup', endHoldTimer);
            item.addEventListener('mouseleave', endHoldTimer);
            item.addEventListener('touchstart', startHoldTimer, { passive: false });
            item.addEventListener('touchend', endHoldTimer);
            item.addEventListener('click', (e) => {
                if (!isHolding) {
                    e.stopPropagation();
                }
            });
        });

        // Eventos para los botones de movimiento
        document.getElementById('up-btn').addEventListener('mousedown', () => { moveState.forward = true; });
        document.getElementById('up-btn').addEventListener('mouseup', () => { moveState.forward = false; });
        document.getElementById('up-btn').addEventListener('touchstart', (e) => { e.preventDefault(); moveState.forward = true; });
        document.getElementById('up-btn').addEventListener('touchend', (e) => { e.preventDefault(); moveState.forward = false; });
        document.getElementById('down-btn').addEventListener('mousedown', () => { moveState.backward = true; });
        document.getElementById('down-btn').addEventListener('mouseup', () => { moveState.backward = false; });
        document.getElementById('down-btn').addEventListener('touchstart', (e) => { e.preventDefault(); moveState.backward = true; });
        document.getElementById('down-btn').addEventListener('touchend', (e) => { e.preventDefault(); moveState.backward = false; });
        document.getElementById('left-btn').addEventListener('mousedown', () => { moveState.left = true; });
        document.getElementById('left-btn').addEventListener('mouseup', () => { moveState.left = false; });
        document.getElementById('left-btn').addEventListener('touchstart', (e) => { e.preventDefault(); moveState.left = true; });
        document.getElementById('left-btn').addEventListener('touchend', (e) => { e.preventDefault(); moveState.left = false; });
        document.getElementById('right-btn').addEventListener('mousedown', () => { moveState.right = true; });
        document.getElementById('right-btn').addEventListener('mouseup', () => { moveState.right = false; });
        document.getElementById('right-btn').addEventListener('touchstart', (e) => { e.preventDefault(); moveState.right = true; });
        document.getElementById('right-btn').addEventListener('touchend', (e) => { e.preventDefault(); moveState.right = false; });

        // Lógica para cambiar la velocidad
        const speedBtn = document.getElementById('speed-button');
        function toggleSpeed() {
            if (currentSpeed === 5.0) {
                currentSpeed = 10.0;
                speedBtn.classList.add('active');
            } else {
                currentSpeed = 5.0;
                speedBtn.classList.remove('active');
            }
        }
        speedBtn.addEventListener('mousedown', (e) => { e.preventDefault(); toggleSpeed(); });
        speedBtn.addEventListener('touchstart', (e) => { e.preventDefault(); toggleSpeed(); });

        // Posición inicial de la cámara
        cameraContainer.position.set(0, 0, 20);

        // SECCIÓN 5: Bucle Principal de Renderizado (Animate)
        // ---------------------------------------------------

        // Ajuste de la pantalla al cambiar el tamaño de la ventana
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize);

        // Función principal que se ejecuta en cada frame
        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            // Optimización: solo renderizar los estantes visibles
            updateVisibility();

            // Lógica de movimiento
            direction.set(0, 0, 0);
            if (moveState.forward) direction.z -= 1;
            if (moveState.backward) direction.z += 1;
            if (moveState.left) direction.x -= 1;
            if (moveState.right) direction.x += 1;

            if (direction.length() > 0) {
                direction.normalize();
                const rotationMatrix = new THREE.Matrix4();
                rotationMatrix.extractRotation(cameraContainer.matrix);
                cameraContainer.position.add(direction.applyMatrix4(rotationMatrix).multiplyScalar(currentSpeed * delta));
            }

            cameraContainer.position.y += velocity.y * delta;
            if (cameraContainer.position.y > groundY + 0) {
                velocity.y -= 9.8 * delta;
            } else {
                velocity.y = 0;
                cameraContainer.position.y = groundY;
            }

            prevTime = time;
            renderer.render(scene, camera);
        }

        // Función para controlar la visibilidad de los estantes
        function updateVisibility() {
            const renderDistance = 60;
            const cameraPosition = cameraContainer.position;

            allShelves.forEach(shelf => {
                const distance = shelf.position.distanceTo(cameraPosition);
                shelf.visible = distance < renderDistance;
            });
        }

        // ¡Inicia la animación!
        animate();
    </script>
</body>
</html>
